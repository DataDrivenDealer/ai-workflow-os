# Agent Mode Definitions
# 
# 定义 PLAN Agent 和 EXECUTE Agent 的行为边界与交接协议
# 版本: 1.0.0
# 创建日期: 2026-02-05
# 
# 与 configs/operating_modes.yaml 配合使用

schema_version: "1.0"

# =============================================================================
# AGENT MODE DEFINITIONS
# =============================================================================

agent_modes:

  # ---------------------------------------------------------------------------
  # PLAN AGENT — 规划 Agent
  # ---------------------------------------------------------------------------
  plan_agent:
    id: "plan_agent"
    display_name: "Plan Agent"
    description: |
      专注于规划、研究和 Spec 管理的 Agent 模式。
      不执行代码，不修改实现，只产出规划和决策。
    
    # 触发条件
    triggers:
      explicit:
        - "开启PLAN MODE"
        - "开启规划模式"
        - "启动规划"
        - "进入规划模式"
        - "PLAN MODE"
        - "planning mode"
        - "只规划不执行"
      implicit:
        - "state/plan_mode_state.yaml exists AND active: true"
    
    # 能力边界
    capabilities:
      allowed:
        - read_file                    # 读取任何文件
        - grep_search                  # 搜索代码
        - semantic_search              # 语义搜索
        - file_search                  # 文件搜索
        - fetch_webpage                # 网络研究 (via external_research subagent)
        - list_dir                     # 目录浏览
        - write_spec_files             # 写入 specs/ 目录
        - write_state_files            # 写入 state/ 目录
        - write_docs_files             # 写入 docs/ 目录
        - invoke_subagent              # 调用 Subagent
      
      prohibited:
        - write_code_files             # 不能写 .py, .ts, .js 等
        - run_in_terminal              # 不能执行终端命令（研究除外）
        - run_tests                    # 不能运行测试
        - run_notebook_cell            # 不能运行 notebook
        - modify_implementation        # 不能修改实现代码
    
    # 可调用的 Subagents
    allowed_subagents:
      - repo_specs_retrieval
      - external_research
      - quant_risk_review           # 仅用于规划阶段的风险评估
      - spec_drift
    
    # 必须满足的 Gates
    required_gates:
      - Gate-P1                      # Specs Scan
      - Gate-P8                      # Write-back Attachment
    
    optional_gates:
      - Gate-P6                      # DRS (可跳过但需理由)
    
    # 产出物
    outputs:
      required:
        - "state/execution_queue.yaml"   # 执行队列
        - "state/plan_mode_state.yaml"   # 规划状态
      optional:
        - "specs/*.yaml"                 # Spec 更新
        - "docs/decisions/*.md"          # 决策记录
        - "docs/subagents/runs/*"        # Subagent 输出
    
    # 退出条件
    exit_conditions:
      normal:
        - "execution_queue.queue.length > 0"
        - "execution_queue.queue[0].acceptance_criteria NOT empty"
        - "execution_queue.queue[0].spec_pointers NOT empty"
        - "explicit statement: 'Switch to EXECUTE MODE'"
      escalation_resolution:
        - "escalation_queue.metadata.pending_count == 0"
        - "execution_queue.metadata.paused == false"
        - "explicit statement: 'Resume EXECUTE MODE'"
    
    # 状态文件
    state_file: "state/plan_mode_state.yaml"

  # ---------------------------------------------------------------------------
  # EXECUTE AGENT — 执行 Agent
  # ---------------------------------------------------------------------------
  execute_agent:
    id: "execute_agent"
    display_name: "Execute Agent"
    description: |
      专注于任务执行和验证的 Agent 模式。
      按照 execution_queue 顺序执行任务，不进行规划或重新排序。
    
    # 触发条件
    triggers:
      explicit:
        - "执行模式"
        - "EXECUTE MODE"
        - "开始执行"
        - "继续执行"
        - "Switch to EXECUTE MODE"
        - "Resume EXECUTE MODE"
      implicit:
        - "state/execution_queue.yaml exists AND queue.stats.pending > 0"
        - "no active PLAN MODE session"
    
    # 能力边界
    capabilities:
      allowed:
        - read_file                    # 读取任何文件
        - grep_search                  # 搜索代码
        - semantic_search              # 语义搜索
        - file_search                  # 文件搜索
        - list_dir                     # 目录浏览
        - write_code_files             # 可以写代码
        - run_in_terminal              # 可以执行命令
        - run_tests                    # 可以运行测试
        - run_notebook_cell            # 可以运行 notebook
        - replace_string_in_file       # 可以编辑文件
        - create_file                  # 可以创建文件
        - invoke_subagent              # 调用 Subagent (限 review gate)
      
      prohibited:
        - write_spec_files             # 不能修改 specs/ (需 escalate)
        - reorder_queue                # 不能重新排序队列
        - add_tasks                    # 不能添加任务
        - modify_priorities            # 不能修改优先级
        - fetch_webpage                # 不能进行网络研究 (会导致规划偏离)
    
    # 可调用的 Subagents (限 Review Gate)
    allowed_subagents:
      - repo_specs_retrieval          # 用于验证实现与 Spec 一致性
      - quant_risk_review             # 用于风险检查
    
    prohibited_subagents:
      - external_research              # 禁止！会导致规划偏离
    
    # 必须满足的 Gates
    required_gates:
      - Gate-E0                       # Pre-execution Check
      - Gate-E5                       # Risk Review (当触发条件满足时)
    
    # 产出物
    outputs:
      required:
        - "state/execution_queue.yaml"   # 队列状态更新
      optional:
        - "projects/dgsf/repo/src/**"    # 实现代码
        - "projects/dgsf/repo/tests/**"  # 测试代码
        - "docs/subagents/runs/*"        # Subagent 输出 (限 review)
    
    # 退出条件
    exit_conditions:
      queue_complete:
        - "execution_queue.stats.pending == 0"
        - "suggest: PLAN MODE for next batch"
      escalation:
        - "escalation triggered"
        - "switch to: PLAN MODE"
      blocker:
        - "unresolvable blocker detected"
        - "pause queue and suggest: PLAN MODE"
    
    # 状态文件
    state_file: "state/execution_queue.yaml"

# =============================================================================
# MODE HANDOFF PROTOCOL（模式交接协议）
# =============================================================================

handoff_protocol:
  
  # Plan → Execute 交接
  plan_to_execute:
    trigger: "Switch to EXECUTE MODE"
    pre_conditions:
      - "execution_queue.yaml exists"
      - "execution_queue.queue.length > 0"
      - "execution_queue.queue[0].acceptance_criteria NOT empty"
      - "execution_queue.queue[0].required_subagents defined"
    handoff_data:
      - file: "state/execution_queue.yaml"
        content: "完整的执行队列"
      - file: "state/plan_mode_state.yaml"
        content: "规划会话状态 (可选参考)"
    post_actions:
      - "Execute Agent 加载 execution_queue.yaml"
      - "显示队列摘要"
      - "询问是否开始执行第一个任务"
  
  # Execute → Plan 交接 (Escalation)
  execute_to_plan:
    trigger: "escalation OR blocker OR queue complete"
    pre_conditions:
      - "escalation_queue.yaml updated (if escalation)"
      - "execution_queue.yaml updated with current status"
    handoff_data:
      - file: "state/escalation_queue.yaml"
        content: "上报的问题列表 (if escalation)"
      - file: "state/execution_queue.yaml"
        content: "当前队列状态 (可能含 blocked/paused)"
    post_actions:
      - "Plan Agent 检查 escalation_queue"
      - "进入 P0.5 Escalation Check 阶段"
      - "解决问题后返回 Execute Mode"
  
  # 跨会话恢复
  session_resume:
    on_new_session:
      - "检查 state/plan_mode_state.yaml"
      - "检查 state/execution_queue.yaml"
      - "检查 state/escalation_queue.yaml"
    resume_priority:
      1: "escalation_queue.pending_count > 0 → PLAN MODE"
      2: "plan_mode_state.active == true → PLAN MODE"
      3: "execution_queue.stats.pending > 0 → EXECUTE MODE"
      4: "default → suggest PLAN MODE"

# =============================================================================
# EXPERT-PATTERN CONFIGURATION（Expert-Pattern 配置）
# =============================================================================

expert_patterns:
  
  # Plan Agent 的 Expert-Pattern
  plan_agent:
    mode: "AUTO"  # AUTO | ON | OFF
    trigger_conditions:
      - "cross_layer_conflict"
      - "drs_required"
      - "context_overload"
      - "broad_scan_requested"
      - "architecture_decision"
    activated_patterns:
      - "QUANT_RESEARCH"
      - "SYSTEMS_DESIGN"
      - "DATA_ENGINEERING"
      - "RISK_MANAGEMENT"
      - "SPEC_GOVERNANCE"
  
  # Execute Agent 的 Expert-Pattern
  execute_agent:
    mode: "REVIEW_ONLY"  # 固定值，不可更改
    usage_scope:
      - "Gate-E5 Review"
      - "验证代码与 Spec 一致性"
      - "风险评估"
    prohibited_usage:
      - "规划"
      - "重新排序"
      - "Spec 修改建议 (必须 escalate)"

# =============================================================================
# VALIDATION RULES（验证规则）
# =============================================================================

validation:
  
  # Plan Agent 验证
  plan_agent:
    on_exit:
      - check: "execution_queue.yaml exists"
        error: "必须创建执行队列"
      - check: "execution_queue.queue.length > 0"
        error: "执行队列不能为空"
      - check: "execution_queue.queue[0].acceptance_criteria NOT empty"
        error: "第一个任务必须有验收标准"
      - check: "execution_queue.queue[0].required_subagents defined"
        error: "第一个任务必须定义 required_subagents"
      - check: "subagent_artifacts attached (if subagents invoked)"
        error: "Gate-P8: Subagent 输出未附加"
  
  # Execute Agent 验证
  execute_agent:
    on_task_start:
      - check: "Gate-E0 satisfied"
        error: "RequiredSubagents 未完成"
      - check: "task.acceptance_criteria NOT empty"
        error: "任务缺少验收标准"
    on_task_complete:
      - check: "all acceptance_criteria verified"
        error: "验收标准未全部通过"
      - check: "subagent_usage logged"
        error: "Subagent 使用未记录到审计日志"
