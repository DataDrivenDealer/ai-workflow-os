# AI Workflow OS State Machine Configuration
# Version: 0.3.0
# Derived From: GOVERNANCE_INVARIANTS, ROLE_MODE_CANON, MULTI_AGENT_CANON, PAIR_PROGRAMMING_STANDARD

# =============================================================================
# TASK STATES
# =============================================================================
states:
  - draft
  - ready
  - running
  - code_review      # NEW: Pair Programming - code submitted for review
  - revision_needed  # NEW: Pair Programming - revision requested by reviewer
  - reviewing
  - merged
  - released
  - blocked
  - abandoned

transitions:
  - from: draft
    to: ready
  - from: draft
    to: running
  - from: ready
    to: running
  # Pair Programming transitions
  - from: running
    to: code_review
    trigger: submit_for_review
  - from: code_review
    to: revision_needed
    trigger: review_request_revision
  - from: code_review
    to: reviewing
    trigger: review_approved
  - from: revision_needed
    to: code_review
    trigger: revision_submitted
  - from: revision_needed
    to: running
    trigger: major_rework_needed
  # Legacy direct path (for non-code tasks)
  - from: running
    to: reviewing
  - from: reviewing
    to: merged
  - from: merged
    to: released
  # Block/unblock transitions
  - from: running
    to: blocked
  - from: blocked
    to: running
  - from: reviewing
    to: blocked
  - from: blocked
    to: reviewing
  - from: code_review
    to: blocked
  - from: blocked
    to: code_review
  # Abandon transitions
  - from: draft
    to: abandoned
  - from: ready
    to: abandoned
  - from: running
    to: abandoned
  - from: blocked
    to: abandoned
  - from: code_review
    to: abandoned
  - from: revision_needed
    to: abandoned

# =============================================================================
# ROLE MODES (from ROLE_MODE_CANON)
# =============================================================================
role_modes:
  architect:
    description: "Constitutional and structural design"
    permissions:
      - read_all_governance
      - propose_l0_changes
      - propose_l1_changes
      - design_governance_structures
    prohibitions:
      - execute_domain_tasks
      - accept_artifacts
      - freeze_artifacts
      - grant_authority
      - modify_authoritative_artifacts
    authority_level: none  # All outputs speculative

  planner:
    description: "Planning, decomposition, and specification"
    permissions:
      - read_all_artifacts
      - define_plans
      - define_roadmaps
      - define_specifications
      - decompose_tasks
      - define_validation_criteria
      - create_l2_specs
    prohibitions:
      - modify_l0_artifacts
      - modify_l1_artifacts
      - execute_implementation
      - accept_artifacts
      - freeze_artifacts
      - validate_own_outputs
    authority_level: none

  executor:
    description: "Execution and implementation"
    permissions:
      - read_task_definitions
      - read_relevant_specs
      - perform_execution_tasks
      - produce_artifact_drafts
      - generate_evidence
      - generate_execution_trace
      - request_task_transitions
    prohibitions:
      - define_requirements
      - define_specifications
      - validate_own_outcomes
      - commit_state_directly
      - modify_governance_artifacts
      - accept_artifacts
      - freeze_artifacts
      - switch_to_higher_role
    authority_level: none

  builder:
    description: "Constrained composite - execution with limited planning"
    permissions:
      # Inherits all executor permissions
      - read_task_definitions
      - read_relevant_specs
      - perform_execution_tasks
      - produce_artifact_drafts
      - generate_evidence
      - generate_execution_trace
      - request_task_transitions
      # Limited planner permissions
      - decompose_assigned_task
      - adjust_implementation_approach
    prohibitions:
      # Inherits all prohibitions from both modes
      - modify_l0_artifacts
      - modify_l1_artifacts
      - authorize_role_changes
      - accept_artifacts
      - freeze_artifacts
      - define_new_task_scope
      - create_l0_proposals
      - create_l1_proposals
      - self_validate
      - self_accept
    authority_level: none

  reviewer:
    description: "Code review and quality assurance - Pair Programming partner"
    permissions:
      - read_all_code_artifacts
      - read_task_definitions
      - read_task_requirements
      - read_spec_references
      - generate_review_report
      - propose_code_improvements
      - flag_quality_issues
      - flag_security_issues
      - flag_performance_issues
      - request_revision
      - approve_review
    prohibitions:
      - execute_code_changes_directly
      - modify_code_artifacts
      - accept_artifacts
      - freeze_artifacts
      - modify_task_scope
      - self_review  # Cannot review own code
      - modify_l0_artifacts
      - modify_l1_artifacts
      - create_tasks
    authority_level: none  # All review outputs are speculative

# =============================================================================
# ROLE MODE TRANSITIONS
# =============================================================================
role_mode_transitions:
  # Only Project Owner can authorize role mode changes
  authorized_by: project_owner
  
  # Allowed transitions (requires explicit authorization)
  allowed:
    - from: executor
      to: builder
    - from: builder
      to: executor
    - from: planner
      to: builder
    - from: builder
      to: planner
  
  # Prohibited (escalation)
  prohibited:
    - from: executor
      to: planner
      reason: "Cannot escalate from execution to planning"
    - from: executor
      to: architect
      reason: "Cannot escalate from execution to architecture"
    - from: builder
      to: architect
      reason: "Cannot escalate from builder to architecture"
    - from: planner
      to: architect
      reason: "Cannot escalate from planning to architecture"
    - from: "*"
      to: "*"
      self: true
      reason: "Self-escalation is prohibited"

# =============================================================================
# AGENT SESSION CONFIGURATION
# =============================================================================
agent_session:
  required_fields:
    - agent_id          # Unique identifier for the agent
    - role_mode         # Active role mode
    - session_token     # Concurrency control token
    - started_at        # ISO timestamp
    - authorized_by     # Who authorized this session
  
  optional_fields:
    - expires_at        # Session expiration (ISO timestamp)
    - task_scope        # Bound task IDs (if any)
    - parent_session    # For delegation tracking
  
  constraints:
    max_concurrent_sessions_per_agent: 1
    session_timeout_minutes: 480  # 8 hours default
    require_explicit_termination: true
  
  lifecycle_states:
    - anonymous         # Before authorization
    - active            # Authorized and operating
    - suspended         # Temporarily paused
    - terminated        # Ended (cannot resume)

# =============================================================================
# AUTHORITY STATES (for artifacts)
# =============================================================================
authority_states:
  - speculative   # No authority, freely mutable
  - accepted      # Active authority, controlled mutation
  - frozen        # Immutable historical authority

authority_transitions:
  - from: speculative
    to: accepted
    action: accept
    authorized_by: project_owner
  - from: accepted
    to: frozen
    action: freeze
    authorized_by: project_owner
  - from: accepted
    to: speculative
    action: reject
    authorized_by: project_owner
  - from: frozen
    to: speculative
    action: supersede
    authorized_by: project_owner
    requires: new_artifact_accepted

# =============================================================================
# GOVERNANCE GATE CHECKS
# =============================================================================
governance_gates:
  authority_integrity:
    description: "No execution output claims authority"
    checks:
      - no_authority_claim_in_output
      - no_governance_action_implied
      - no_binding_without_record

  role_mode_integrity:
    description: "Each action is attributable to exactly one Role Mode"
    checks:
      - single_role_mode_per_action
      - no_implicit_switching
      - no_escalation_inferred

  state_integrity:
    description: "System state reconstructable from artifacts only"
    checks:
      - state_from_artifacts_only
      - no_execution_side_memory_as_state
      - no_implicit_state_transition

  workflow_spine_integrity:
    description: "No implicit stage progression"
    checks:
      - explicit_stage_progression
      - no_execution_validation_collapse
      - no_inferred_completion

  concurrency_isolation:
    description: "Parallel executions do not combine authority"
    checks:
      - no_authority_amplification
      - conflicting_drafts_isolated
      - no_collective_legitimacy
# =============================================================================
# PAIR PROGRAMMING CONFIGURATION
# =============================================================================
pair_programming:
  enabled: true
  
  # Review dimensions and their checks
  review_dimensions:
    quality_check:
      id: Q
      description: "Code quality and bug detection"
      checks:
        - id: Q-001
          name: syntax_correctness
          severity_default: CRITICAL
        - id: Q-002
          name: type_safety
          severity_default: MAJOR
        - id: Q-003
          name: error_handling
          severity_default: MAJOR
        - id: Q-004
          name: null_handling
          severity_default: MAJOR
        - id: Q-005
          name: resource_cleanup
          severity_default: MAJOR
        - id: Q-006
          name: security_vulnerabilities
          severity_default: CRITICAL
        - id: Q-007
          name: performance_antipatterns
          severity_default: MINOR
        - id: Q-008
          name: code_duplication
          severity_default: MINOR
    
    requirements_check:
      id: R
      description: "Requirements verification"
      checks:
        - id: R-001
          name: functional_requirements_met
          severity_default: CRITICAL
        - id: R-002
          name: input_validation
          severity_default: MAJOR
        - id: R-003
          name: output_format
          severity_default: MAJOR
        - id: R-004
          name: edge_cases_handled
          severity_default: MAJOR
        - id: R-005
          name: integration_points
          severity_default: MAJOR
        - id: R-006
          name: api_contracts
          severity_default: CRITICAL
    
    completeness_check:
      id: C
      description: "Completeness verification"
      checks:
        - id: C-001
          name: all_requirements_covered
          severity_default: CRITICAL
        - id: C-002
          name: acceptance_criteria_addressed
          severity_default: MAJOR
        - id: C-003
          name: referenced_specs_implemented
          severity_default: MAJOR
        - id: C-004
          name: tests_included
          severity_default: MINOR
        - id: C-005
          name: documentation_updated
          severity_default: MINOR
    
    optimization_check:
      id: O
      description: "Code optimization opportunities"
      checks:
        - id: O-001
          name: simplification_possible
          severity_default: SUGGESTION
        - id: O-002
          name: algorithm_efficiency
          severity_default: SUGGESTION
        - id: O-003
          name: abstraction_improvement
          severity_default: SUGGESTION
        - id: O-004
          name: naming_clarity
          severity_default: SUGGESTION
        - id: O-005
          name: idiomatic_code
          severity_default: SUGGESTION
        - id: O-006
          name: complexity_reduction
          severity_default: SUGGESTION

  # Issue severity levels
  severity_levels:
    - name: CRITICAL
      blocks_merge: true
      description: "Security vulnerability, data loss risk, crash"
    - name: MAJOR
      blocks_merge: true
      description: "Functional bug, missing requirement"
    - name: MINOR
      blocks_merge: false
      description: "Code smell, minor bug"
    - name: SUGGESTION
      blocks_merge: false
      description: "Optimization opportunity"

  # Verdict determination rules
  verdicts:
    APPROVED:
      condition: "no CRITICAL and no MAJOR issues"
    NEEDS_REVISION:
      condition: "has CRITICAL or MAJOR issues"
    BLOCKED:
      condition: "missing critical requirements or blocker found"

  # Expert reviewer personas
  personas:
    security_expert:
      focus: ["Q-006", "R-002"]
      description: "OWASP, injection, auth, data protection"
    performance_expert:
      focus: ["Q-007", "O-002", "O-006"]
      description: "Algorithms, caching, I/O optimization"
    architecture_expert:
      focus: ["O-003", "Q-008"]
      description: "SOLID, design patterns, coupling, cohesion"
    domain_expert:
      focus: ["R-001", "R-004", "C-001"]
      description: "Business logic, requirements alignment"
    testing_expert:
      focus: ["C-004", "R-004"]
      description: "Test coverage, edge cases, assertions"

  # Self-review prohibition
  self_review_prohibited: true
  
  # Maximum revision cycles before escalation
  max_revision_cycles: 3
  
  # Artifact types requiring review
  review_required_for:
    - "*.py"
    - "*.js"
    - "*.ts"
    - "*.yaml"
    - "*.json"
  
  review_optional_for:
    - "*.md"
    - "*.txt"