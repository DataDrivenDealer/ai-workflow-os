# AI Workflow OS State Machine Configuration
# Version: 0.4.0
# Derived From: GOVERNANCE_INVARIANTS, ROLE_MODE_CANON, MULTI_AGENT_CANON, PAIR_PROGRAMMING_STANDARD
# 
# Changelog:
#   v0.4.0 (2026-02-04): Added formal concurrency semantics (AEP-6/Phase 1)
#   v0.3.0: Added Pair Programming support

# =============================================================================
# CONCURRENCY MODEL (AEP-6 Phase 1)
# =============================================================================
# Formal concurrency semantics for multi-agent operation (5-20 concurrent agents)
# Addresses Tension A1/A2: Explicit locking and conflict resolution

concurrency:
  version: "1.0.0"
  max_concurrent_agents: 20
  
  # Locking model
  locking:
    model: "optimistic_with_fallback"  # optimistic | pessimistic | optimistic_with_fallback
    description: |
      Primary: Optimistic concurrency with version vectors
      Fallback: File-based pessimistic locking when conflicts detected
    
    # Optimistic concurrency control
    optimistic:
      enabled: true
      version_field: "_version"
      conflict_detection: "version_mismatch"
      retry_on_conflict: 3
      retry_delay_ms: 100
      
    # Pessimistic fallback
    pessimistic:
      enabled: true
      lock_timeout_seconds: 30
      lock_granularity: "per_resource"  # per_resource | per_project | global
      stale_lock_threshold_seconds: 300  # Auto-release locks older than this
      
  # Conflict resolution strategies
  conflict_resolution:
    default_strategy: "last_writer_wins_with_audit"
    
    strategies:
      last_writer_wins_with_audit:
        description: "Accept last write but log conflict for audit"
        audit: true
        notification: "conflict_detected"
        
      merge_if_compatible:
        description: "Attempt JSON merge if changes don't overlap"
        fallback: "last_writer_wins_with_audit"
        
      reject_and_retry:
        description: "Reject conflicting write, force re-read"
        max_retries: 3
        
      human_resolution:
        description: "Queue for human resolution"
        queue: "governance"
        priority: "P2"
    
    # Per-resource strategy overrides
    resource_overrides:
      "state/tasks.yaml":
        strategy: "merge_if_compatible"
        merge_rules:
          - field: "tasks.*"
            rule: "per_task_merge"
          - field: "queues.*"
            rule: "append_only"
            
      "state/project.yaml":
        strategy: "reject_and_retry"
        rationale: "Project-level changes should be coordinated"
        
      "projects/*/adapter.yaml":
        strategy: "reject_and_retry"
        rationale: "Adapter changes require explicit coordination"

  # State transition atomicity
  transitions:
    atomicity: "per_task"  # per_task | per_agent | global
    isolation_level: "read_committed"
    
    # Concurrent transition handling
    concurrent_transition_rules:
      same_task:
        policy: "serialize"
        description: "Transitions on same task are serialized"
        
      wip_check:
        policy: "atomic_increment"
        description: "WIP limit check is atomic with transition"
        
      cross_task:
        policy: "independent"
        description: "Different tasks can transition concurrently"

  # Agent session management for concurrency
  session_isolation:
    enabled: true
    
    # Each agent session has isolated view until commit
    isolation:
      read: "snapshot"  # snapshot | latest
      write: "buffered"  # buffered | immediate
      commit: "atomic"
      
    # Session-level locks
    session_locks:
      max_locks_per_session: 10
      lock_timeout_seconds: 60
      deadlock_detection: true
      deadlock_resolution: "youngest_victim"

  # Health monitoring for concurrency
  monitoring:
    enabled: true
    metrics:
      - name: "lock_contention_rate"
        description: "Percentage of lock acquisitions that had to wait"
        alert_threshold: 0.3  # >30% contention = problem
        
      - name: "conflict_rate"
        description: "Percentage of writes that detected conflicts"
        alert_threshold: 0.1  # >10% conflicts = problem
        
      - name: "avg_lock_wait_ms"
        description: "Average time waiting for locks"
        alert_threshold: 500  # >500ms = problem
        
      - name: "deadlock_count"
        description: "Number of deadlocks detected"
        alert_threshold: 1  # Any deadlock = investigate
        
    dashboard: "reports/concurrency_health.md"
    refresh_interval: "1h"

# =============================================================================
# TASK STATES
# =============================================================================
states:
  - draft
  - ready
  - running
  - code_review      # NEW: Pair Programming - code submitted for review
  - revision_needed  # NEW: Pair Programming - revision requested by reviewer
  - reviewing
  - merged
  - released
  - blocked
  - abandoned

transitions:
  - from: draft
    to: ready
  - from: draft
    to: running
  - from: ready
    to: running
  # Pair Programming transitions
  - from: running
    to: code_review
    trigger: submit_for_review
  - from: code_review
    to: revision_needed
    trigger: review_request_revision
  - from: code_review
    to: reviewing
    trigger: review_approved
  - from: revision_needed
    to: code_review
    trigger: revision_submitted
  - from: revision_needed
    to: running
    trigger: major_rework_needed
  # Legacy direct path (for non-code tasks)
  - from: running
    to: reviewing
  - from: reviewing
    to: merged
  - from: merged
    to: released
  # Block/unblock transitions
  - from: running
    to: blocked
  - from: blocked
    to: running
  - from: reviewing
    to: blocked
  - from: blocked
    to: reviewing
  - from: code_review
    to: blocked
  - from: blocked
    to: code_review
  # Abandon transitions
  - from: draft
    to: abandoned
  - from: ready
    to: abandoned
  - from: running
    to: abandoned
  - from: blocked
    to: abandoned
  - from: code_review
    to: abandoned
  - from: revision_needed
    to: abandoned

# =============================================================================
# ROLE MODES (from ROLE_MODE_CANON)
# =============================================================================
# AEP-4: Enhanced with Tiered Authority Levels
# Authority levels enable progressive trust escalation based on agent performance

role_modes:
  architect:
    description: "Constitutional and structural design"
    permissions:
      - read_all_governance
      - propose_l0_changes
      - propose_l1_changes
      - design_governance_structures
    prohibitions:
      - execute_domain_tasks
      - accept_artifacts
      - freeze_artifacts
      - grant_authority
      - modify_authoritative_artifacts
    authority_level: 0  # Speculative only
    promotable_to: null  # Cannot be promoted

  planner:
    description: "Planning, decomposition, and specification"
    permissions:
      - read_all_artifacts
      - define_plans
      - define_roadmaps
      - define_specifications
      - decompose_tasks
      - define_validation_criteria
      - create_l2_specs
    prohibitions:
      - modify_l0_artifacts
      - modify_l1_artifacts
      - execute_implementation
      - accept_artifacts
      - freeze_artifacts
      - validate_own_outputs
    authority_level: 0
    promotable_to: null

  executor:
    description: "Execution and implementation"
    permissions:
      - read_task_definitions
      - read_relevant_specs
      - perform_execution_tasks
      - produce_artifact_drafts
      - generate_evidence
      - generate_execution_trace
      - request_task_transitions
    prohibitions:
      - define_requirements
      - define_specifications
      - validate_own_outcomes
      - commit_state_directly
      - modify_governance_artifacts
      - accept_artifacts
      - freeze_artifacts
      - switch_to_higher_role
    authority_level: 0
    promotable_to: 1  # Can be promoted to assisted

  builder:
    description: "Constrained composite - execution with limited planning"
    permissions:
      # Inherits all executor permissions
      - read_task_definitions
      - read_relevant_specs
      - perform_execution_tasks
      - produce_artifact_drafts
      - generate_evidence
      - generate_execution_trace
      - request_task_transitions
      # Limited planner permissions
      - decompose_assigned_task
      - adjust_implementation_approach
    prohibitions:
      # Inherits all prohibitions from both modes
      - modify_l0_artifacts
      - modify_l1_artifacts
      - authorize_role_changes
      - accept_artifacts
      - freeze_artifacts
      - define_new_task_scope
      - create_l0_proposals
      - create_l1_proposals
      - self_validate
      - self_accept
    authority_level: 0
    promotable_to: 2  # Can be promoted up to delegated

  reviewer:
    description: "Code review and quality assurance - Pair Programming partner"
    permissions:
      - read_all_code_artifacts
      - read_task_definitions
      - read_task_requirements
      - read_spec_references
      - generate_review_report
      - propose_code_improvements
      - flag_quality_issues
      - flag_security_issues
      - flag_performance_issues
      - request_revision
      - approve_review
    prohibitions:
      - execute_code_changes_directly
      - modify_code_artifacts
      - accept_artifacts
      - freeze_artifacts
      - modify_task_scope
      - self_review  # Cannot review own code
      - modify_l0_artifacts
      - modify_l1_artifacts
      - create_tasks
    authority_level: 0
    promotable_to: null

# =============================================================================
# AEP-4: TIERED AUTHORITY LEVELS
# =============================================================================
# Progressive trust model for agent authority escalation
# Each level unlocks additional permissions while maintaining safety boundaries

authority_levels:
  level_0:
    name: "speculative"
    value: 0
    description: "All outputs require human approval before taking effect"
    permissions:
      - propose_changes
      - request_review
      - generate_drafts
    restrictions:
      - no_direct_commits
      - no_file_modifications
      - no_state_changes
    default: true  # All new sessions start here

  level_1:
    name: "assisted"
    value: 1
    description: "Can execute in isolated sandbox environment"
    permissions:
      - all_level_0_permissions
      - execute_in_sandbox
      - run_tests_in_sandbox
      - create_draft_branches
    restrictions:
      - no_merge_to_any_branch
      - sandbox_only_execution
      - no_production_data_access
    promotion_criteria:
      session_task_success_rate:
        operator: ">="
        value: 0.9
        window: "30d"
      no_rule_violations:
        rules: ["R3", "R4", "R5"]
        window: "30d"
      minimum_task_count:
        value: 10
    demotion_triggers:
      - rule_id: "R4"
        action: "immediate_demotion_to_0"
      - consecutive_failures: 3
        action: "demotion_to_0"

  level_2:
    name: "delegated"
    value: 2
    description: "Can merge to non-protected branches with audit"
    permissions:
      - all_level_1_permissions
      - merge_to_feature_branches
      - create_pull_requests
      - auto_apply_formatting
    restrictions:
      - no_merge_to_main
      - no_merge_to_release
      - requires_ci_pass
      - requires_audit_log
    promotion_criteria:
      level_1_duration:
        operator: ">="
        value: "7d"
      human_approval:
        type: "explicit"
        approver: "project_lead"
      continued_success_rate:
        operator: ">="
        value: 0.95
    demotion_triggers:
      - rule_id: "R4"
        action: "immediate_demotion_to_0"
      - merge_caused_ci_failure: 2
        action: "demotion_to_1"

  level_3:
    name: "trusted"
    value: 3
    description: "Reserved for future - potential merge to protected branches"
    permissions:
      - all_level_2_permissions
      - placeholder_for_future
    restrictions:
      - requires_explicit_human_co_sign
    status: "not_implemented"
    note: "Level 3+ requires significant additional safety mechanisms"

# Authority level management
authority_management:
  evaluation_frequency: "daily"
  max_level_per_role:
    executor: 1
    builder: 2
    reviewer: 1
    planner: 0
    architect: 0
  
  audit_requirements:
    promotion: "logged_with_rationale"
    demotion: "logged_with_evidence"
    
  override:
    enabled: true
    requires: "project_owner"
    use_case: "emergency_demotion"

# =============================================================================
# ROLE MODE TRANSITIONS
# =============================================================================
role_mode_transitions:
  # Only Project Owner can authorize role mode changes
  authorized_by: project_owner
  
  # Allowed transitions (requires explicit authorization)
  allowed:
    - from: executor
      to: builder
    - from: builder
      to: executor
    - from: planner
      to: builder
    - from: builder
      to: planner
  
  # Prohibited (escalation)
  prohibited:
    - from: executor
      to: planner
      reason: "Cannot escalate from execution to planning"
    - from: executor
      to: architect
      reason: "Cannot escalate from execution to architecture"
    - from: builder
      to: architect
      reason: "Cannot escalate from builder to architecture"
    - from: planner
      to: architect
      reason: "Cannot escalate from planning to architecture"
    - from: "*"
      to: "*"
      self: true
      reason: "Self-escalation is prohibited"

# =============================================================================
# AGENT SESSION CONFIGURATION
# =============================================================================
agent_session:
  required_fields:
    - agent_id          # Unique identifier for the agent
    - role_mode         # Active role mode
    - session_token     # Concurrency control token
    - started_at        # ISO timestamp
    - authorized_by     # Who authorized this session
  
  optional_fields:
    - expires_at        # Session expiration (ISO timestamp)
    - task_scope        # Bound task IDs (if any)
    - parent_session    # For delegation tracking
  
  constraints:
    max_concurrent_sessions_per_agent: 1
    session_timeout_minutes: 480  # 8 hours default
    require_explicit_termination: true
  
  lifecycle_states:
    - anonymous         # Before authorization
    - active            # Authorized and operating
    - suspended         # Temporarily paused
    - terminated        # Ended (cannot resume)

# =============================================================================
# AUTHORITY STATES (for artifacts)
# =============================================================================
authority_states:
  - speculative   # No authority, freely mutable
  - accepted      # Active authority, controlled mutation
  - frozen        # Immutable historical authority

authority_transitions:
  - from: speculative
    to: accepted
    action: accept
    authorized_by: project_owner
  - from: accepted
    to: frozen
    action: freeze
    authorized_by: project_owner
  - from: accepted
    to: speculative
    action: reject
    authorized_by: project_owner
  - from: frozen
    to: speculative
    action: supersede
    authorized_by: project_owner
    requires: new_artifact_accepted

# =============================================================================
# GOVERNANCE GATE CHECKS
# =============================================================================
governance_gates:
  authority_integrity:
    description: "No execution output claims authority"
    checks:
      - no_authority_claim_in_output
      - no_governance_action_implied
      - no_binding_without_record

  role_mode_integrity:
    description: "Each action is attributable to exactly one Role Mode"
    checks:
      - single_role_mode_per_action
      - no_implicit_switching
      - no_escalation_inferred

  state_integrity:
    description: "System state reconstructable from artifacts only"
    checks:
      - state_from_artifacts_only
      - no_execution_side_memory_as_state
      - no_implicit_state_transition

  workflow_spine_integrity:
    description: "No implicit stage progression"
    checks:
      - explicit_stage_progression
      - no_execution_validation_collapse
      - no_inferred_completion

  concurrency_isolation:
    description: "Parallel executions do not combine authority"
    checks:
      - no_authority_amplification
      - conflicting_drafts_isolated
      - no_collective_legitimacy
# =============================================================================
# PAIR PROGRAMMING CONFIGURATION
# =============================================================================
pair_programming:
  enabled: true
  
  # Review dimensions and their checks
  review_dimensions:
    quality_check:
      id: Q
      description: "Code quality and bug detection"
      checks:
        - id: Q-001
          name: syntax_correctness
          severity_default: CRITICAL
        - id: Q-002
          name: type_safety
          severity_default: MAJOR
        - id: Q-003
          name: error_handling
          severity_default: MAJOR
        - id: Q-004
          name: null_handling
          severity_default: MAJOR
        - id: Q-005
          name: resource_cleanup
          severity_default: MAJOR
        - id: Q-006
          name: security_vulnerabilities
          severity_default: CRITICAL
        - id: Q-007
          name: performance_antipatterns
          severity_default: MINOR
        - id: Q-008
          name: code_duplication
          severity_default: MINOR
    
    requirements_check:
      id: R
      description: "Requirements verification"
      checks:
        - id: R-001
          name: functional_requirements_met
          severity_default: CRITICAL
        - id: R-002
          name: input_validation
          severity_default: MAJOR
        - id: R-003
          name: output_format
          severity_default: MAJOR
        - id: R-004
          name: edge_cases_handled
          severity_default: MAJOR
        - id: R-005
          name: integration_points
          severity_default: MAJOR
        - id: R-006
          name: api_contracts
          severity_default: CRITICAL
    
    completeness_check:
      id: C
      description: "Completeness verification"
      checks:
        - id: C-001
          name: all_requirements_covered
          severity_default: CRITICAL
        - id: C-002
          name: acceptance_criteria_addressed
          severity_default: MAJOR
        - id: C-003
          name: referenced_specs_implemented
          severity_default: MAJOR
        - id: C-004
          name: tests_included
          severity_default: MINOR
        - id: C-005
          name: documentation_updated
          severity_default: MINOR
    
    optimization_check:
      id: O
      description: "Code optimization opportunities"
      checks:
        - id: O-001
          name: simplification_possible
          severity_default: SUGGESTION
        - id: O-002
          name: algorithm_efficiency
          severity_default: SUGGESTION
        - id: O-003
          name: abstraction_improvement
          severity_default: SUGGESTION
        - id: O-004
          name: naming_clarity
          severity_default: SUGGESTION
        - id: O-005
          name: idiomatic_code
          severity_default: SUGGESTION
        - id: O-006
          name: complexity_reduction
          severity_default: SUGGESTION

  # Issue severity levels
  severity_levels:
    - name: CRITICAL
      blocks_merge: true
      description: "Security vulnerability, data loss risk, crash"
    - name: MAJOR
      blocks_merge: true
      description: "Functional bug, missing requirement"
    - name: MINOR
      blocks_merge: false
      description: "Code smell, minor bug"
    - name: SUGGESTION
      blocks_merge: false
      description: "Optimization opportunity"

  # Verdict determination rules
  verdicts:
    APPROVED:
      condition: "no CRITICAL and no MAJOR issues"
    NEEDS_REVISION:
      condition: "has CRITICAL or MAJOR issues"
    BLOCKED:
      condition: "missing critical requirements or blocker found"

  # Expert reviewer personas
  personas:
    security_expert:
      focus: ["Q-006", "R-002"]
      description: "OWASP, injection, auth, data protection"
    performance_expert:
      focus: ["Q-007", "O-002", "O-006"]
      description: "Algorithms, caching, I/O optimization"
    architecture_expert:
      focus: ["O-003", "Q-008"]
      description: "SOLID, design patterns, coupling, cohesion"
    domain_expert:
      focus: ["R-001", "R-004", "C-001"]
      description: "Business logic, requirements alignment"
    testing_expert:
      focus: ["C-004", "R-004"]
      description: "Test coverage, edge cases, assertions"

  # Self-review prohibition
  self_review_prohibited: true
  
  # Maximum revision cycles before escalation
  max_revision_cycles: 3
  
  # Artifact types requiring review
  review_required_for:
    - "*.py"
    - "*.js"
    - "*.ts"
    - "*.yaml"
    - "*.json"
  
  review_optional_for:
    - "*.md"
    - "*.txt"