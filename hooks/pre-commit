#!/usr/bin/env sh
# Pre-commit hook: Run policy check, branch validation, file conventions, and basic validations
# Updated: 2026-02-06 by Copilot OS — Added file system governance checks (R9)

echo "Running pre-commit checks..."

# Detect Python executable (prefer venv if available)
if [ -f ".venv/Scripts/python.exe" ]; then
    PYTHON=".venv/Scripts/python.exe"
elif [ -f ".venv/bin/python" ]; then
    PYTHON=".venv/bin/python"
elif command -v python3 &> /dev/null; then
    PYTHON="python3"
else
    PYTHON="python"
fi

echo "Using Python: $PYTHON"

# ======================================================================
# PHASE 0: Branch naming policy check (BLOCK enforcement)
# ======================================================================
CURRENT_BRANCH=$(git branch --show-current 2>/dev/null)
if [ -n "$CURRENT_BRANCH" ]; then
    if [ -f "kernel/git_branch_validator.py" ]; then
        $PYTHON -m kernel.git_branch_validator 2>&1
        BRANCH_EXIT=$?
        if [ $BRANCH_EXIT -ne 0 ]; then
            echo ""
            echo "[BLOCK] Branch name '${CURRENT_BRANCH}' violates naming policy."
            echo "        See configs/git_branch_policy.yaml for allowed formats."
            echo ""
            echo "  Quick fix — rename your branch:"
            echo "    git branch -m feature/TASK_ID-description"
            echo "    git branch -m experiment/t05_my_experiment"
            echo ""
            exit 1
        fi
    fi
fi

# ======================================================================
# PHASE 0.5: Protected branch check
# ======================================================================
if [ "$CURRENT_BRANCH" = "main" ]; then
    echo ""
    echo "[BLOCK] Direct commits to 'main' are not allowed."
    echo "        Create a feature branch first:"
    echo "          git checkout -b feature/TASK_ID-description"
    echo ""
    exit 1
fi

# ======================================================================
# PHASE 1: File system governance check (R9 enforcement)
# ======================================================================
if [ -f "scripts/check_file_conventions.py" ]; then
    echo ""
    echo "Checking file naming conventions..."
    $PYTHON scripts/check_file_conventions.py --staged 2>&1
    CONVENTION_EXIT=$?
    if [ $CONVENTION_EXIT -eq 1 ]; then
        echo ""
        echo "[BLOCK] File convention violations found (R9)."
        echo "        See: configs/file_system_governance.yaml"
        echo ""
        exit 1
    fi
    # Exit code 2 = warnings only, continue
fi

# Check if yaml module is available
$PYTHON -c "import yaml" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "[WARN] Warning: PyYAML not installed, skipping YAML validation"
    echo "   Install with: pip install PyYAML"
    SKIP_YAML=1
else
    SKIP_YAML=0
fi

# Run policy check (graceful degradation)
if [ -f "scripts/policy_check.py" ]; then
    $PYTHON scripts/policy_check.py --mode precommit 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "[WARN] Policy check skipped (dependency missing)"
    fi
fi

# Run pyright type checking on kernel/ (if pyright is available)
if command -v pyright &> /dev/null; then
    echo "Running pyright type checking on kernel/..."
    pyright kernel/ --level warning 2>&1 | head -n 20
    PYRIGHT_EXIT=$?
    if [ $PYRIGHT_EXIT -ne 0 ]; then
        echo "[WARN] Pyright found type issues (non-blocking)"
        echo "   Run 'pyright kernel/' to see full report"
        # Non-blocking: don't exit on pyright errors
    else
        echo "[OK] Pyright type checking passed"
    fi
else
    echo "[INFO] Pyright not installed, skipping type checking"
    echo "   Install with: npm install -g pyright"
fi

# Validate YAML files (if yaml module available)
if [ "$SKIP_YAML" = "0" ]; then
    $PYTHON -c "
import yaml
import sys
from pathlib import Path

errors = []
for f in Path('.').rglob('*.yaml'):
    if '.git' in str(f):
        continue
    try:
        with open(f, encoding='utf-8') as h:
            yaml.safe_load(h)
    except Exception as e:
        errors.append(f'{f}: {e}')

if errors:
    print('[FAIL] YAML validation failed:')
    for e in errors:
        print(f'  {e}')
    sys.exit(1)
"
    if [ $? -ne 0 ]; then
        exit 1
    fi
fi

echo "[OK] Pre-commit checks passed"
exit 0
