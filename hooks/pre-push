#!/usr/bin/env sh
# Pre-push hook: Run gate checks and branch validation before pushing
# Updated: 2026-02-06 by Copilot OS â€” Added branch naming enforcement

echo "Running pre-push gate checks..."

# Detect Python executable (prefer venv if available)
if [ -f ".venv/Scripts/python.exe" ]; then
    PYTHON=".venv/Scripts/python.exe"
elif [ -f ".venv/bin/python" ]; then
    PYTHON=".venv/bin/python"
elif command -v python3 &> /dev/null; then
    PYTHON="python3"
else
    PYTHON="python"
fi

echo "Using Python: $PYTHON"

# ======================================================================
# PHASE 0: Branch naming policy check (BLOCK enforcement)
# ======================================================================
CURRENT_BRANCH=$(git branch --show-current 2>/dev/null)
if [ -n "$CURRENT_BRANCH" ]; then
    if [ -f "kernel/git_branch_validator.py" ]; then
        $PYTHON -m kernel.git_branch_validator 2>&1
        BRANCH_EXIT=$?
        if [ $BRANCH_EXIT -ne 0 ]; then
            echo ""
            echo "[BLOCK] Push rejected: branch '${CURRENT_BRANCH}' violates naming policy."
            echo "        Rename your branch first:"
            echo "          git branch -m feature/TASK_ID-description"
            echo ""
            exit 1
        fi
    fi
fi

# ======================================================================
# PHASE 0.5: Hooks installation check (informational on push)
# ======================================================================
if [ -f "kernel/git_setup_check.py" ]; then
    $PYTHON -c "
from kernel.git_setup_check import check_git_hooks, format_setup_status
status = check_git_hooks()
if not status.hooks_installed:
    print(format_setup_status(status))
" 2>/dev/null
fi

# Run policy check (graceful degradation)
if [ -f "scripts/policy_check.py" ]; then
    $PYTHON scripts/policy_check.py --mode prepush 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "[WARN] Policy check skipped (dependency missing)"
    fi
fi

# Run G2 sanity checks (unit tests) - graceful degradation
if [ -f "scripts/gate_check.py" ]; then
    $PYTHON scripts/gate_check.py --gate G2 --output text 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "[WARN] G2 gate check has warnings/errors (push allowed)"
    fi
fi

# Run state machine transition validation (graceful degradation)
if [ -f "scripts/verify_state_transitions.py" ]; then
    $PYTHON scripts/verify_state_transitions.py 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "[WARN] State transition validation failed (push allowed)"
    fi
fi

echo "[OK] Pre-push checks complete"
exit 0
