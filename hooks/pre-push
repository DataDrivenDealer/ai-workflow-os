#!/usr/bin/env sh
# Pre-push hook: Run gate checks before pushing
# Updated: 2026-02-01 by 张平台 - Added venv detection

echo "Running pre-push gate checks..."

# Detect Python executable (prefer venv if available)
if [ -f ".venv/Scripts/python.exe" ]; then
    PYTHON=".venv/Scripts/python.exe"
elif [ -f ".venv/bin/python" ]; then
    PYTHON=".venv/bin/python"
elif command -v python3 &> /dev/null; then
    PYTHON="python3"
else
    PYTHON="python"
fi

echo "Using Python: $PYTHON"

# Run policy check (graceful degradation)
if [ -f "scripts/policy_check.py" ]; then
    $PYTHON scripts/policy_check.py --mode prepush 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "[WARN] Policy check skipped (dependency missing)"
    fi
fi

# Run G2 sanity checks (unit tests) - graceful degradation
if [ -f "scripts/gate_check.py" ]; then
    $PYTHON scripts/gate_check.py --gate G2 --output text 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "[WARN] G2 gate check has warnings/errors (push allowed)"
    fi
fi

echo "[OK] Pre-push checks complete"
exit 0
