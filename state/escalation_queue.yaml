# Escalation Queue State
# Purpose: Execute Mode 向 Plan Mode 上报问题的交接契约
# Lifecycle: Execute Mode 创建/追加 → Plan Mode 消费/解决
# Location: state/escalation_queue.yaml

escalation_queue:
  version: "1.0"
  
  # ==========================================================================
  # METADATA（元数据）
  # ==========================================================================
  metadata:
    # 创建信息
    created_at: "2026-02-05T14:45:00Z"
    last_updated: "2026-02-05T15:40:00Z"
    last_updated_by: "plan_mode"
    
    # 上报统计
    total_escalations: 3
    pending_count: 0
    resolved_count: 3
    
  # ==========================================================================
  # ESCALATION ITEMS（上报项）
  # ==========================================================================
  items:
    - id: "ESC-2026-02-05-001"
      
      # 来源信息
      source:
        mode: "execute_mode"
        task_id: "SDF_FEATURE_ENG_001"
        subtask_id: "T3.2"
        queue_item_id: 2
        session_context: "执行 T3.2 特征计算逻辑验证时发现 AC 定义与代码结构不匹配"
      
      # 问题分类
      type: "spec_error"
      severity: "medium"
      
      # 问题描述
      title: "T3.2 AC 指向 placeholder 模块，实际计算在 DE7"
      description: |
        T3.2 的验收标准要求验证 `dgsf.factors.compute` 的 point-in-time 合规性
        和测试覆盖率，但该模块实际上是 placeholder（空实现）。
        
        真正的特征计算逻辑在 `dataeng/de7_factor_panel_a0_builder.py`，
        该模块正确使用 `.shift(1)` 确保 point-in-time 合规。
        
        问题：
        1. AC-1 (no lookahead) - 无法验证 compute.py，因为是空的
        2. AC-2 (80% 覆盖率) - pytest --cov=dgsf.factors.compute 无意义
        
        实际情况：
        - factors/compute.py: placeholder，只有类定义
        - dataeng/de7_factor_panel_a0_builder.py: 真正的特征计算，23 个因子
      
      # 受影响的 Specs
      affected_specs:
        - path: "tasks/active/SDF_FEATURE_ENG_001.md"
          section: "T3.2"
        - path: "state/execution_queue.yaml"
          section: "queue[1] (T3.2)"
      
      # 建议的处理方式
      suggested_action: "update_spec"
      suggested_resolution: |
        选项 1: 重新定义 T3.2 AC，指向 DE7 模块
          - AC-1: 验证 de7_factor_panel_a0_builder.py 的 point-in-time 合规
          - AC-2: 验证 DE7 相关测试覆盖率
        
        选项 2: 将 factors/compute.py 的实现纳入后续任务 (T3.3+)
          - 当前 T3.2 跳过或重新定义
          - T3.3 实现 factors/ 模块
      
      # 状态
      status: "resolved"
      created_at: "2026-02-05T14:45:00Z"
      resolved_at: "2026-02-05T15:00:00Z"
      resolution_notes: |
        采用选项 A: 重新定义 T3.2 AC，指向 DE7 模块。
        - AC-1: 验证 DE7 使用 .shift() 确保 point-in-time
        - AC-2: DE7 相关测试通过
        - AC-3: 生成合规报告
        队列已恢复。
    - id: "ESC-2026-02-05-002"
      
      # 来源信息
      source:
        mode: "execute_mode"
        task_id: "SDF_TEST_FIX_001"
        subtask_id: "Phase2"
        queue_item_id: 3
        session_context: "执行 Phase2 时发现验收标准要求全库测试 100% 通过，但当前失败跨多个模块，且与任务卡范围不一致"
      
      # 问题分类
      type: "spec_error"
      severity: "high"
      
      # 问题描述
      title: "Phase2 验收标准与任务卡范围不一致"
      description: |
        execution_queue.yaml 的 Phase2 要求全库测试 100% 通过，但任务卡
        SDF_TEST_FIX_001.md 的 Phase2 仅要求执行 tests/sdf 并分类失败。
        
        当前运行全库测试结果：60 failed, 1026 passed, 57 skipped。
        失败集中于 dataeng、paneltree、rolling、de9 等模块，范围远超 SDF。
        
        这导致 Phase2 无法在 2 小时内完成，且与既定范围不一致。
      
      # 受影响的 Specs
      affected_specs:
        - path: "tasks/active/SDF_TEST_FIX_001.md"
          section: "Phase 2"
        - path: "state/execution_queue.yaml"
          section: "queue[2] (Phase2)"
      
      # 建议的处理方式
      suggested_action: "update_spec"
      suggested_resolution: |
        选项 1: 将 Phase2 验收标准改为仅覆盖 tests/sdf/，并输出失败分类。
        选项 2: 拆分全库测试失败为新的 P1/P2 任务，避免阻塞 SDF 进度。
      
      # 状态
      status: "resolved"
      created_at: "2026-02-05T15:25:00Z"
      resolved_at: "2026-02-05T15:40:00Z"
      resolution_notes: |
        采用 suggested_resolution 选项 1：将 Phase2 验收标准改为仅覆盖 tests/sdf/。
        execution_queue.yaml 已将 Phase2 从“全库 100% 通过”收敛为：
        - 运行 tests/sdf/ 并输出摘要
        - 生成失败分类清单
        - 保存测试输出到 projects/dgsf/reports/SDF_TEST_RESULTS.txt
        队列已恢复。
    - id: "ESC-2026-02-05-003"

      # 来源信息
      source:
        mode: "execute_mode"
        task_id: "DE7_QA_AUDIT_001"
        subtask_id: "DE7.2"
        queue_item_id: 9
        session_context: "执行 DE7 QA 与 v2 修复时发现关键数据文件缺失"

      # 问题分类
      type: "spec_missing"
      severity: "high"

      # 问题描述
      title: "DE7 v2 修复与 A0 QA 所需数据文件缺失"
      description: |
        A0 panel build 失败：缺少 data/raw/a0_universe.parquet。
        DE7 v2 修复失败：v2 输入文件缺失，builder 回退为空数据，无法产出。

        缺失清单：
        - data/raw/a0_universe.parquet
        - data/a0/interim/de3_fina_income_eff.parquet
        - data/a0/interim/de3_fina_balance_eff.parquet
        - data/a0/interim/de3_fina_cashflow_eff.parquet
        - data/a0/interim/de4_fina_indicator_eff.parquet
        - data/full/de1_canonical_daily.parquet
        - data/full/de1_canonical_monthly.parquet
        - data/interim/fullwindow/de5/de5_market_micro_monthly.parquet
        - data/interim/fullwindow/de6/universe_mask.parquet

      # 受影响的 Specs
      affected_specs:
        - path: "projects/dgsf/repo/configs/de7_fullwindow_v2.yaml"
          section: "factor_panel_input"
        - path: "projects/dgsf/repo/docs/qa/de7_qa_loop.md"
          section: "How to Run the QA Checks"

      # 建议的处理方式
      suggested_action: "update_spec"
      suggested_resolution: |
        1) 明确数据路径与数据可用性来源（或提供替代路径）。
        2) 若数据不可用，定义可接受的 stub/跳过策略与验收标准。

      # 状态
      status: "resolved"
      created_at: "2026-02-05T21:10:00Z"
      acknowledged_at: "2026-02-06T10:00:00Z"
      resolved_at: "2026-02-06T10:00:00Z"
      resolution_notes: |
        已在 2026-02-06 PLAN MODE 中整合处理。
        创建了完整的 DE Fullwindow 升级计划：
        - 诊断发现 DE3/DE4 A0 interim 仅覆盖到 2019 年末
        - Raw data 已完整 (201501-202601)
        - 规划了 DE.CFG → DE.3 → DE.4 → DE.5 → DE.6 → DE.7 重建任务链
        - 写入 execution_queue.yaml 待执行
        
        参见：docs/plans/DE_FULLWINDOW_UPGRADE_PLAN_20260206.md
  #   
  #   # 状态跟踪
  #   status: pending | acknowledged | in_progress | resolved | deferred
  #   created_at: "2026-02-05T14:30:00Z"
  #   acknowledged_at: null
  #   resolved_at: null
  #   
  #   # 解决信息（Plan Mode 填充）
  #   resolution:
  #     action_taken: null  # spec_updated | code_updated | research_completed | deferred
  #     summary: null
  #     updated_specs: []
  #     updated_queue_items: []  # 需要重新执行的队列项
  
  # ==========================================================================
  # ESCALATION TYPES REFERENCE（上报类型参考）
  # ==========================================================================
  # 
  # type: spec_unclear
  #   描述: Spec 定义不够清晰，需要澄清
  #   默认 severity: low
  #   建议处理: 标记后继续执行，批量处理
  #
  # type: spec_error
  #   描述: Spec 中有明显错误
  #   默认 severity: medium
  #   建议处理: 暂停相关任务，等待修复
  #
  # type: spec_missing
  #   描述: 缺少执行所需的 Spec 定义
  #   默认 severity: high
  #   建议处理: 阻塞相关任务，创建 Spec
  #
  # type: research_needed
  #   描述: 遇到需要调研的开放性问题
  #   默认 severity: medium
  #   建议处理: 创建研究任务，可继续其他任务
  #
  # type: refactor_required
  #   描述: 需要对 Spec 或架构进行重构
  #   默认 severity: high
  #   建议处理: 上报 Plan Mode，评估影响范围
  #
  # type: blocker
  #   描述: 完全阻塞执行的问题
  #   默认 severity: critical
  #   建议处理: 立即切换到 Plan Mode

  # ==========================================================================
  # SEVERITY TO ACTION MAPPING（严重程度与行动映射）
  # ==========================================================================
  severity_actions:
    low:
      description: "标记后继续执行"
      queue_impact: "none"  # 不影响队列
      mode_switch: false
    medium:
      description: "暂停相关任务，继续其他任务"
      queue_impact: "block_related"  # 阻塞相关任务
      mode_switch: false
    high:
      description: "暂停队列，建议切换到 Plan Mode"
      queue_impact: "pause_queue"  # 暂停整个队列
      mode_switch: "suggested"  # 建议切换
    critical:
      description: "立即切换到 Plan Mode"
      queue_impact: "halt"  # 停止执行
      mode_switch: "required"  # 必须切换

  # ==========================================================================
  # HISTORY（历史记录）
  # ==========================================================================
  history: []
  # - timestamp: "2026-02-05T14:30:00Z"
  #   action: "escalation_created"
  #   actor: "execute_mode"
  #   escalation_id: "ESC-2026-02-05-001"
  #   
  # - timestamp: "2026-02-05T15:00:00Z"
  #   action: "escalation_resolved"
  #   actor: "plan_mode"
  #   escalation_id: "ESC-2026-02-05-001"
  #   resolution: "spec_updated"

