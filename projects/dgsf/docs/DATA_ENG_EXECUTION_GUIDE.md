# DGSF Data Engineering Stage 6 - Execution Guide

**Version**: P0-26 to P0-30  
**Status**: Implementation Complete, Ready for Full Execution  
**Date**: 2026-02-01  

---

## ðŸ“Š Pipeline Overview

| Stage | Script | Sample Status | Full Runtime | Output |
|-------|--------|---------------|--------------|--------|
| **DE1** | `de1_batch_runner.py` | âœ… 12,466 rows (5 stocks) | ~2-4 hrs | `daily_prices.parquet` (~12.9M rows) |
| **DE2** | `de2_macro_loader.py` | âœ… 132 rows (COMPLETE) | < 1 min | `de2_macro_monthly.parquet` |
| **DE3/4** | `de3_financial_loader.py` | âœ… 231 rows (3 stocks) | ~2-4 hrs | `de3_fina_indicator.parquet` (~400K rows) |
| **DE5/6** | `de5_microstructure_loader.py` | âœ… 15,322 rows (3 days) | ~3-6 hrs | `de5_daily_basic.parquet` (~13.8M rows) |
| **DE7/8** | `de7_factor_panel.py` | ðŸ”² Pending DE1-DE6 | ~30 min | `de7_factor_panel.parquet` |

---

## ðŸš€ Execution Instructions

### Option A: Batch Files (Recommended for Full Run)

Run each batch file in a **standalone Windows CMD** (not VS Code terminal):

```batch
# Step 1: Market Data (DE1) - ~2-4 hours
scripts\run_de1_full.bat

# Step 2: Financial Data (DE3/4) - ~2-4 hours
scripts\run_de3_full.bat

# Step 3: Microstructure (DE5/6) - ~3-6 hours
scripts\run_de5_full.bat
```

**DE2 Macro** is already complete (output in `data/raw/macro_monthly.parquet`).

### Option B: Python Direct (with resume support)

```bash
# DE1: Batch processing with checkpoints
python scripts/de1_batch_runner.py

# Resume from specific batch if interrupted
python scripts/de1_batch_runner.py --start-batch 20

# Merge checkpoints only
python scripts/de1_batch_runner.py --merge-only
```

---

## ðŸ“ Output Files

### Raw Data (`data/raw/`)
| File | Rows | Description |
|------|------|-------------|
| `daily_prices_sample.parquet` | 12,466 | Sample daily OHLCV (5 stocks) |
| `adj_factor_sample.parquet` | 12,466 | Sample adjustment factors |
| `macro_monthly.parquet` | 132 | âœ… Complete macro data |
| `macro_cpi.parquet` | 132 | CPI monthly |
| `macro_ppi.parquet` | 132 | PPI monthly |
| `macro_m2.parquet` | 132 | Money supply monthly |
| `macro_gdp.parquet` | 44 | GDP quarterly |
| `macro_pmi.parquet` | 132 | PMI monthly |
| `fina_indicator_sample.parquet` | 231 | Sample financial data |
| `daily_basic_sample.parquet` | 15,322 | Sample microstructure |

### Full Data (`data/full/`)
| File | Est. Rows | Description |
|------|-----------|-------------|
| `de1_canonical_daily.parquet` | ~12.9M | Full daily prices |
| `de2_macro_monthly.parquet` | 132 | âœ… Complete |
| `de3_fina_indicator.parquet` | ~400K | Financial indicators |
| `de5_daily_basic.parquet` | ~13.8M | Microstructure metrics |
| `de6_universe_mask.parquet` | ~13.8M | Tradeable mask |

---

## â±ï¸ Total Estimated Runtime

| Component | Runtime |
|-----------|---------|
| DE1 (Market) | 2-4 hours |
| DE2 (Macro) | âœ… Done |
| DE3/4 (Financial) | 2-4 hours |
| DE5/6 (Microstructure) | 3-6 hours |
| **Total** | **~8-14 hours** |

**Recommendation**: Run overnight with scripts in sequence.

---

## ðŸ“‹ Validation Checklist

- [x] P0-25: Tushare API Coverage Audit - PASS
- [x] P0-26: DE1 Sample Validation - 12,466 rows, correct schema
- [x] P0-27: DE2 Full Execution - 132 rows, causality aligned
- [x] P0-28: DE3/4 Sample Validation - 231 rows, correct schema
- [x] P0-29: DE5/6 Sample Validation - 15,322 rows, correct schema
- [ ] P0-30: DE7/8 Factor Panel - Pending DE1-DE6 completion

---

## ðŸ”§ Troubleshooting

### Interrupted Execution
All loaders support checkpointing. Simply re-run the script and it will resume:
```bash
python scripts/de1_batch_runner.py  # Auto-resumes from last checkpoint
```

### Merge Only (after all batches complete)
```bash
python scripts/de1_batch_runner.py --merge-only
python scripts/de3_financial_loader.py --merge-only
python scripts/de5_microstructure_loader.py --merge-only
```

### API Rate Limits
Default delays (120-150ms) are conservative. If you hit limits, increase `API_DELAY` in scripts.

---

## ðŸ“ Schema Reference

### DE1 daily_prices
```
ts_code, trade_date, open, high, low, close, pre_close, change, pct_chg, vol, amount
```

### DE2 macro_monthly
```
month, cpi_yoy, cpi_mom, ppi_yoy, m2, m2_yoy, m1, m1_yoy, pmi_mfg, pmi_non_mfg, gdp, gdp_yoy, effective_date
```

### DE3 fina_indicator
```
ts_code, ann_date, end_date, roe, roa, grossprofit_margin, netprofit_margin, ..., effective_date
```

### DE5 daily_basic
```
ts_code, trade_date, turnover_rate, turnover_rate_f, volume_ratio, total_mv, circ_mv, pe, pe_ttm, pb
```

---

*Generated by DGSF Data Engineering Pipeline P0-26 to P0-30*
