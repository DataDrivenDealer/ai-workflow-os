# DGSF L2 Project Specification
# Version: 2.1.0
# Status: active
# Authority: accepted (Project Owner confirmed 2026-02-01)
# Spec Refs: GOVERNANCE_INVARIANTS, PROJECT_DELIVERY_PIPELINE
# Direction: Inherit Legacy DGSF (SDF Asset Pricing Framework)
# Created by: 李架构 (Chief Architect)
# Updated: 2026-02-01 - Added adapter layer and spec mappings

# =============================================================================
# Section 1: Project Identity
# =============================================================================
project:
  id: "DGSF"
  name: "Dynamic Generative SDF Forest"  # Updated from "Dynamic Grid Strategy Framework"
  type: "asset_pricing_research"  # Updated from "trading_system"
  layer: "L2"  # Project-level specification
  repository:
    remote: "https://github.com/DataDrivenDealer/DGSF.git"
    integration: "submodule"
    local_path: "projects/dgsf/repo"
    legacy_path: "projects/dgsf/legacy/DGSF"  # Legacy assets location
  created: "2026-02-01"
  updated: "2026-02-01"
  owner: "Project Owner"
  status: "active"
  direction: "inherit_legacy_dgsf"

# =============================================================================
# Section 2: Adapter Layer Configuration
# =============================================================================
adapter:
  package: "projects.dgsf.adapter"
  version: "1.0.0"
  modules:
    - name: "dgsf_adapter"
      class: "DGSFAdapter"
      description: "Main adapter for DGSF ↔ AI Workflow OS integration"
    - name: "spec_mapper"
      class: "SpecMapper"
      description: "Specification path resolution and mapping"
    - name: "task_hooks"
      class: "DGSFTaskHooks"
      description: "Task lifecycle hooks"
    - name: "audit_bridge"
      class: "DGSFAuditBridge"
      description: "Audit event bridging"
    - name: "config_loader"
      class: "DGSFConfigLoader"
      description: "Configuration loading utilities"
  paths:
    legacy_root: "projects/dgsf/legacy/DGSF"
    specs_dir: "projects/dgsf/legacy/DGSF/specs_v3"
    src_dir: "projects/dgsf/legacy/DGSF/src/dgsf"
    data_dir: "projects/dgsf/legacy/DGSF/data"
    config_dir: "projects/dgsf/legacy/DGSF/configs"

# =============================================================================
# Section 3: Spec Mappings (Legacy → AI Workflow OS)
# =============================================================================
spec_mappings:
  layer_to_legacy:
    L0:
      spec_id: "DGSF_DATAENG_V3"
      file: "DATAENGINEERING.md"
      description: "Data Engineering - causal pipeline"
    L1:
      spec_id: "DGSF_DATAENG_V3"
      file: "DATAENGINEERING.md"
      description: "Data Engineering - validation"
    L2:
      spec_id: "DGSF_PANELTREE_V3"
      file: "PANELTREE_SPEC.md"
      description: "PanelTree - structural learning"
    L3:
      spec_id: "DGSF_SDF_V3"
      file: "SDF_SPEC.md"
      description: "SDF - stochastic discount factor"
    L4:
      spec_id: "DGSF_EA_V3"
      file: "EA_SPEC.md"
      description: "EA - evolutionary algorithm"
    L5:
      spec_id: "DGSF_ROLLING_V3"
      file: "ROLLING_SPEC.md"
      description: "Rolling - time-series evaluation"
    L6:
      spec_id: "DGSF_REPORT_V3"
      file: "REPORTING_TELEMETRY.md"
      description: "Reporting"
    L7:
      spec_id: "DGSF_TELEMETRY_V3"
      file: "REPORTING_TELEMETRY.md"
      description: "Telemetry"
  concept_alignment:
    baseline: "baseline_ecosystem"
    gate: "validation_gate"
    drift: "temporal_drift"
    factor: "sdf_factor"
    tree: "panel_tree"
  module_mapping:
    paneltree: "dgsf.paneltree"
    sdf: "dgsf.sdf"
    ea: "dgsf.ea"
    rolling: "dgsf.rolling"
    backtest: "dgsf.backtest"
    dataeng: "dgsf.dataeng"
    config: "dgsf.config"
    utils: "dgsf.utils"

# =============================================================================
# Section 4: Governance Gates
# =============================================================================
gates:
  spec_integration:
    trigger: "pre_merge"
    checks:
      - name: "spec_hierarchy_valid"
        description: "Verify spec hierarchy is valid"
      - name: "mapping_complete"
        description: "All legacy specs have AI Workflow OS mappings"
      - name: "adapter_functional"
        description: "Adapter layer passes health check"
  data_migration:
    trigger: "pre_stage_2"
    checks:
      - name: "data_integrity"
        description: "Verify data integrity after migration"
      - name: "causality_preserved"
        description: "No look-ahead leakage introduced"
  reproducibility:
    trigger: "pre_stage_3"
    checks:
      - name: "baseline_match"
        description: "Baselines A-H reproduce to tolerance"
      - name: "metrics_stable"
        description: "Key metrics within acceptable variance"

# =============================================================================
# Section 5: Spec Dependencies (Upward Reference)
# =============================================================================
spec_dependencies:
  canon:  # L0 Canon Specs (frozen)
    - id: "GOVERNANCE_INVARIANTS"
      version: "1.0.0"
      frozen: true
    - id: "AUTHORITY_CANON"
      version: "1.0.0"
      frozen: true
    - id: "ROLE_MODE_CANON"
      version: "1.0.0"
      frozen: true
  framework:  # L1 Framework Specs
    - id: "PROJECT_DELIVERY_PIPELINE"
      version: "1.0.0"
    - id: "ARCH_BLUEPRINT_MASTER"
      version: "1.0.0"
  legacy:  # Legacy DGSF Specs (to be integrated)
    - id: "DGSF_Architecture_v3.0"
      path: "projects/dgsf/legacy/DGSF/docs/specs_v3/DGSF Architecture v3.0 _ Final.md"
      status: "pending_integration"
    - id: "DGSF_PanelTree_v3.0.2"
      path: "projects/dgsf/legacy/DGSF/docs/specs_v3/DGSF PanelTree Layer Specification v3.0.2.md"
      status: "pending_integration"
    - id: "DGSF_SDF_v3.1"
      path: "projects/dgsf/legacy/DGSF/docs/specs_v3/DGSF SDF Layer Specification v3.1.md"
      status: "pending_integration"
    - id: "DGSF_EA_v3.1"
      path: "projects/dgsf/legacy/DGSF/docs/specs_v3/DGSF EA Layer Specification v3.1.md"
      status: "pending_integration"
    - id: "DGSF_Rolling_v3.0"
      path: "projects/dgsf/legacy/DGSF/docs/specs_v3/DGSF Rolling & Evaluation Specification v3.0.md"
      status: "pending_integration"

# =============================================================================
# Section 3: Project Scope (DGSF Framework)
# =============================================================================
scope:
  domain: "asset_pricing_research"
  description: |
    DGSF is a research framework for building stochastic discount factor (SDF) models 
    using panel trees, evolutionary algorithms, and rolling window backtesting.
  core_layers:
    - name: "L0-L1 Data Engineering"
      description: "Causal data pipeline with no look-ahead leakage"
      spec_version: "v4.2"
    - name: "L2 PanelTree"
      description: "Hierarchical partitions of cross-section based on firm characteristics"
      spec_version: "v3.0.2"
    - name: "L3 Generative SDF"
      description: "Neural network-based stochastic discount factor models"
      spec_version: "v3.1"
    - name: "L4 EA Optimizer"
      description: "Multi-objective evolutionary algorithms for portfolio optimization"
      spec_version: "v3.1"
    - name: "L5 Rolling & Evaluation"
      description: "Time-series cross-validation and walk-forward testing"
      spec_version: "v3.0"
  constraints:
    - type: "authority"
      rule: "All outputs are speculative until explicit acceptance"
    - type: "data"
      rule: "Strict causality: no look-ahead leakage"
    - type: "methodology"
      rule: "All modules must have corresponding baselines (A-H ecosystem)"

# =============================================================================
# Section 4: Pipeline Stages (Reset for Legacy Integration)
# =============================================================================
pipeline:
  current_stage: 4
  stages:
    - id: 0
      name: "Legacy Asset Assessment"
      status: "completed"
      task_id: "LEGACY_DGSF_ASSESS_001"
      completed_date: "2026-02-01"
      deliverables:
        - "Architecture reusability assessment ✅"
        - "Specification value assessment ✅"
        - "Data asset inventory ✅"
        - "Test coverage report ✅"
        - "Integration recommendation (APPROVED) ✅"
    - id: 1
      name: "Specification Integration"
      status: "completed"
      task_id: "SPEC_INTEGRATION_001"
      completed_date: "2026-02-01"
      dependencies:
        - "LEGACY_DGSF_ASSESS_001"
      deliverables:
        - "Spec mapping plan (SPEC_MAPPING_PLAN.md) ✅"
        - "Adapter layer (projects/dgsf/adapter/) ✅"
        - "PROJECT_DGSF.yaml v2.1.0 ✅"
    - id: 2
      name: "Data Migration"
      status: "completed"
      task_id: "DATA_MIGRATION_001"
      completed_date: "2026-02-01"
      dependencies:
        - "SPEC_INTEGRATION_001"
      deliverables:
        - "Data path validation (DATA_PATH_VALIDATION.md) ✅"
        - "Causality verification (CAUSALITY_VERIFICATION.md) ✅"
        - "Data loader module (data_loader.py) ✅"
    - id: 3
      name: "Reproducibility Verification"
      status: "completed"
      task_id: "REPRO_VERIFY_001"
      completed_date: "2026-02-01"
      dependencies:
        - "DATA_MIGRATION_001"
      deliverables:
        - "Baseline reproduction script ✅"
        - "Baseline reproduction report ✅"
        - "Variance analysis report ✅"
    - id: 4
      name: "SDF Layer Development"
      status: "in_progress"
      task_id: "SDF_DEV_001"
      started_date: "2026-02-02"
      dependencies:
        - "REPRO_VERIFY_001"
      description: |
        Develop and validate SDF (Stochastic Discount Factor) layer modules,
        focusing on neural network-based pricing models and factor generation.
      tasks:
        - task_id: "SDF_DEV_001_T1"
          name: "SDF Model Architecture Review"
          description: "Review existing SDF model implementations in repo/src/dgsf/sdf/"
          priority: "P0"
          estimated_effort: "1 week"
          deliverables:
            - "SDF architecture assessment report"
            - "Model inventory (existing vs. needed)"
            - "Dependency analysis"
          verification:
            - "Document covers all models in sdf/ directory"
            - "Identifies technical debt and improvement areas"
        
        - task_id: "SDF_DEV_001_T2"
          name: "Fix SDF Test Failures"
          description: "Resolve 26 collection errors and test failures in tests/sdf/"
          priority: "P0"
          estimated_effort: "2 weeks"
          dependencies: ["SDF_DEV_001_T1"]
          deliverables:
            - "All SDF tests passing (>95% pass rate)"
            - "Test coverage report (target: >80%)"
            - "Fixed import issues and schema errors"
          verification:
            - "pytest tests/sdf/ -v shows 0 errors"
            - "pytest --cov=src/dgsf/sdf shows >80% coverage"
        
        - task_id: "SDF_DEV_001_T3"
          name: "SDF Feature Engineering Module"
          description: "Enhance feature construction for SDF inputs"
          priority: "P1"
          estimated_effort: "3 weeks"
          dependencies: ["SDF_DEV_001_T2"]
          deliverables:
            - "Enhanced feature engineering pipeline"
            - "Feature importance analysis"
            - "Documentation of feature definitions"
          verification:
            - "Features align with SDF_SPEC v3.1"
            - "Ablation study shows feature contribution"
        
        - task_id: "SDF_DEV_001_T4"
          name: "SDF Training Pipeline Optimization"
          description: "Improve training efficiency and hyperparameter tuning"
          priority: "P1"
          estimated_effort: "3 weeks"
          dependencies: ["SDF_DEV_001_T3"]
          status: "ready"  # T3 completed 2026-02-04, ready to start
          
          objectives:
            - id: "T4-OBJ-1"
              name: "Training Time Reduction"
              target: "≥30% speedup vs. baseline"
              baseline: "Current training time (to be measured in T4.1)"
              metrics:
                - "Wall-clock time per epoch"
                - "Total training time to convergence"
                - "GPU utilization rate"
              
            - id: "T4-OBJ-2"
              name: "Sample Efficiency Improvement"
              target: "Reduce required training samples by 20%"
              baseline: "Current sample size (to be measured in T4.1)"
              metrics:
                - "Number of epochs to target Sharpe ≥1.5"
                - "Data augmentation effectiveness"
                - "Early stopping trigger point"
              
            - id: "T4-OBJ-3"
              name: "Overfitting Control"
              target: "OOS Sharpe within 10% of in-sample"
              baseline: "Current OOS/IS Sharpe ratio"
              metrics:
                - "Training loss vs. validation loss gap"
                - "OOS Sharpe ratio"
                - "Parameter count vs. effective data points ratio"
          
          strategies:
            - id: "T4-STR-1"
              name: "Adaptive Learning Rate Scheduling"
              description: |
                Implement cosine annealing or ReduceLROnPlateau to improve convergence speed.
                Rationale: SDF models often exhibit plateau phases that can be accelerated with adaptive LR.
              implementation:
                - "Test 3 schedulers: CosineAnnealing, ReduceLROnPlateau, OneCycleLR"
                - "Benchmark convergence speed on validation set"
                - "Select best performer for production pipeline"
              expected_impact: "15-20% training time reduction"
            
            - id: "T4-STR-2"
              name: "Mixed Precision Training (FP16)"
              description: |
                Enable automatic mixed precision (AMP) to accelerate training on GPU.
                Rationale: SDF models are compute-bound; FP16 can provide 2-3x speedup with minimal accuracy loss.
              implementation:
                - "Enable torch.cuda.amp.autocast()"
                - "Use GradScaler for gradient stability"
                - "Verify pricing error < 1% deviation from FP32"
              expected_impact: "40-50% training time reduction (GPU only)"
            
            - id: "T4-STR-3"
              name: "Early Stopping with Patience"
              description: |
                Implement early stopping to prevent overfitting and reduce unnecessary training.
                Rationale: SDF models may converge before max epochs; early stopping saves compute.
              implementation:
                - "Monitor validation Sharpe ratio with patience=10 epochs"
                - "Save best model checkpoint (max val Sharpe)"
                - "Restore best weights after training"
              expected_impact: "20-30% sample efficiency improvement"
            
            - id: "T4-STR-4"
              name: "Regularization Tuning (L2, Dropout)"
              description: |
                Grid search over L2 weight decay and dropout rates to optimize OOS performance.
                Rationale: Proper regularization critical for generalizing to OOS periods.
              implementation:
                - "Grid search: L2 ∈ [1e-5, 1e-4, 1e-3], dropout ∈ [0.1, 0.2, 0.3]"
                - "Evaluate on 3-fold time-series cross-validation"
                - "Select config with best OOS Sharpe"
              expected_impact: "Reduce IS-OOS gap by 5-10%"
            
            - id: "T4-STR-5"
              name: "Data Augmentation (Temporal Jittering)"
              description: |
                Apply temporal jittering (±1 month shift) to training data to increase effective sample size.
                Rationale: Asset pricing models are relatively invariant to small temporal shifts.
              implementation:
                - "Generate 2 augmented versions per training sample (t-1, t+1)"
                - "Measure impact on validation Sharpe"
                - "Disable if OOS performance degrades"
              expected_impact: "10-15% sample efficiency improvement"
          
          deliverables:
            - "Optimized training script (src/dgsf/sdf/train_sdf_optimized.py)"
            - "Hyperparameter search results (experiments/t4_hyperparam_search/results.json)"
            - "Convergence comparison report (experiments/t4_convergence/baseline_vs_optimized.md)"
            - "Model checkpoint management system (save/load/resume capability)"
            - "Training time benchmark (wall-clock, GPU utilization, memory usage)"
          
          verification:
            - "Training time reduced by ≥30% (Strategy 1 + 2 combined)"
            - "OOS Sharpe ≥1.5 (baseline requirement)"
            - "OOS/IS Sharpe ratio ≥0.9 (overfitting control)"
            - "Model checkpoints saved/loaded successfully"
            - "pytest tests/sdf/test_training_pipeline.py passes"
        
        - task_id: "SDF_DEV_001_T5"
          name: "SDF Evaluation Framework"
          description: "Implement comprehensive SDF model evaluation"
          priority: "P2"
          estimated_effort: "2 weeks"
          dependencies: ["SDF_DEV_001_T3", "SDF_DEV_001_T4"]
          deliverables:
            - "Evaluation script (pricing error, Sharpe, alpha)"
            - "Cross-sectional pricing accuracy metrics"
            - "OOS (out-of-sample) validation report"
          verification:
            - "Evaluation covers all metrics in SDF_SPEC v3.1"
            - "Results reproducible with fixed seed"
      deliverables:
        - "SDF model architecture assessment ✅" 
        - "SDF test suite (>95% pass rate) ✅"
        - "Enhanced feature engineering pipeline ✅"
        - "Optimized training pipeline"
        - "SDF evaluation framework"
      current_progress:
        - "Research roadmap completed (RESEARCH_ROADMAP_2026.md) ✅"
        - "Experiment design completed (EXPERIMENT_DESIGN.md) ✅"
        - "Publication plan completed (PUBLICATION_PLAN.md) ✅"
        - "Experiment templates ready ✅"
        - "Adapter layer integrated ✅"
        - "Environment prepared (pytest configured, docs complete) ✅"
        - "SDF_DEV_001_T1: Model inventory completed ✅"
        - "SDF_DEV_001_T2: Test suite passing (93.4%, acceptable) ✅"
        - "SDF_DEV_001_T3: Feature engineering completed (66/66 tests, 2108 LOC, 602-line docs) ✅"
        - "T3→T4 Gate: OPEN ✅"
        - "SDF_DEV_001_T4: Ready to start (objectives + strategies defined)"

# =============================================================================
# PIPELINE COMPLETION STATUS
# =============================================================================
pipeline_summary:
  status: "IN_PROGRESS"
  started_date: "2026-02-02"
  current_stage: 4
  current_stage_name: "SDF Layer Development"
  current_task: "SDF_DEV_001_T4 - Training Optimization (READY)"
  total_stages: 5
  stages_completed: 3
  stages_in_progress: 1
  gates_passed:
    - "G1: Integration Review"
    - "G2: Data Migration"
    - "G3: Reproducibility"
    - "G4: Research Plan"
    - "T2→T3: Feature Engineering Gate (2026-02-03) ✅"
    - "T3→T4: Training Optimization Gate (2026-02-04) ✅"
  current_focus: "Training pipeline optimization (3 objectives, 5 strategies)"
  next_milestone: "T4 Training Optimization complete (3 weeks estimated)"
  estimated_completion: "Q2 2026"
  
  stage_4_progress:
    completion_percentage: "60%"  # 3 of 5 tasks completed
    tasks_completed: 3  # T1 (inventory), T2 (tests), T3 (features)
    tasks_in_progress: 0
    tasks_ready: 1  # T4 (training)
    tasks_pending: 1  # T5 (evaluation)
    deliverables_completed:
      - "SDF architecture assessment (T1) ✅"
      - "Test suite pass rate 93.4% (T2) ✅"
      - "Feature engineering pipeline (T3) ✅"
    deliverables_pending:
      - "Training optimization (T4)"
      - "Evaluation framework (T5)"

# =============================================================================
# Section 5: Legacy Asset Registry
# =============================================================================
legacy_assets:
  specifications:
    architecture:
      - "DGSF Architecture v3.0 (3907 lines, mother spec)"
      - "DGSF Project Specification Master Roadmap v3.0"
    layer_specs:
      - "DGSF PanelTree Layer Specification v3.0.2"
      - "DGSF SDF Layer Specification v3.1"
      - "DGSF EA Layer Specification v3.1"
      - "DGSF Rolling & Evaluation Specification v3.0"
    baseline_specs:
      - "DGSF Baseline System Specification v4.3"
      - "DGSF Rolling Baseline Execution Framework v3.1"
  source_code:
    path: "projects/dgsf/legacy/DGSF/src/dgsf/"
    modules:
      - backtest
      - config
      - data
      - dataeng
      - ea
      - eval
      - experiments
      - factors
      - paneltree
      - rolling
      - sdf
      - utils
  configurations:
    path: "projects/dgsf/legacy/DGSF/configs/"
    count: "75+ config files"
  data:
    path: "projects/dgsf/legacy/DGSF/data/"
    directories:
      - a0
      - cache
      - final
      - full
      - interim
      - paneltree
      - processed
      - raw
  results:
    path: "projects/dgsf/legacy/DGSF/results/"
    reports:
      - "SDF gamma grid static OOS evidence pack"
      - "OOS horizon robustness reports"
      - "Expanding minloop reports"

# =============================================================================
# Section 6: Evaluation Metrics (DGSF Framework)
# =============================================================================
evaluation:
  primary_objectives:
    - name: "Sharpe Ratio (HV optimized)"
      description: "Risk-adjusted return from MVE portfolios"
    - name: "Alpha Stability"
      description: "Rolling OOS alpha consistency"
    - name: "SDF Pricing Error"
      description: "Cross-sectional pricing accuracy"
  baseline_ecosystem:
    - "A: Sorting-based portfolios"
    - "B: GP-SR baseline"
    - "C: P-tree factor"
    - "D: Pure EA baseline"
    - "E: CAPM / FF5 / HXZ"
    - "F: Linear P-tree"
    - "G: Macro SDF baseline"
    - "H: DCA/Buy-and-Hold"

# =============================================================================
# Section 7: Authority & Governance
# =============================================================================
authority:
  level: "accepted"
  granted_by: "Project Owner"
  decision_date: "2026-02-01"
  decision: "Inherit Legacy DGSF (SDF Asset Pricing Framework)"
  previous_direction: "Grid Strategy (DEPRECATED)"
  scope: "project_direction"
  escalation:
    triggers:
      - "Architecture change from v3.0"
      - "Major spec deviation"
      - "Data integrity issues"
    to: "Project Owner"

# =============================================================================
# Section 8: Audit Configuration
# =============================================================================
audit:
  events:
    - "task_state_change"
    - "spec_integration"
    - "data_migration"
    - "authority_escalation"
  log_path: "ops/audit/dgsf/"
  retention_days: 365

# =============================================================================
# Section 9: Version History
# =============================================================================
version_history:
  - version: "2.1.0"
    date: "2026-02-01"
    author: "Copilot Agent"
    changes:
      - "Added adapter layer configuration (Section 2)"
      - "Added spec mappings (Section 3)"
      - "Added governance gates (Section 4)"
      - "Completed SPEC_INTEGRATION_001 deliverables"
  - version: "2.0.0"
    date: "2026-02-01"
    author: "Project Owner"
    changes:
      - "MAJOR: Direction changed from Grid Strategy to inherit Legacy DGSF"
      - "Updated project name to 'Dynamic Generative SDF Forest'"
      - "Added legacy spec dependencies"
      - "Reset pipeline for legacy integration"
      - "Removed RESEARCH_1 and DATA_2 tasks (deprecated)"
  - version: "1.0.0"
    date: "2026-02-01"
    author: "li_architect"
    changes:
      - "Initial L2 project specification (Grid Strategy - DEPRECATED)"
