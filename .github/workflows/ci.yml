name: CI

on:
  push:
    branches: ["main", "feature/**"]
  pull_request:

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ===========================================================================
  # Job 1: Policy Check (Spec Registry Governance)
  # ===========================================================================
  policy-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: pip install PyYAML
      - name: Policy check
        run: python scripts/policy_check.py --mode ci

  # ===========================================================================
  # Job 2: Governance Gate Check (5-Dimensional Verification)
  # ===========================================================================
  governance-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: pip install PyYAML
      - name: Governance verification
        run: |
          python -c "
          import sys
          from pathlib import Path
          sys.path.insert(0, str(Path('.').resolve()))
          from kernel.governance_gate import GovernanceGate, has_violations, get_all_violations
          
          gate = GovernanceGate()
          results = gate.verify_all()
          
          has_errors = False
          for r in results:
              status = '❌' if r.has_violations else '✅'
              print(f'{status} {r.gate_name}: {len(r.violations)} violations')
              if r.has_violations:
                  has_errors = True
                  for v in r.violations:
                      print(f'   - [{v.rule_id}] {v.description}')
          
          sys.exit(1 if has_errors else 0)
          "

  # ===========================================================================
  # Job 3: Kernel Unit Tests
  # ===========================================================================
  kernel-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-lock.txt', 'requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements-lock.txt ]; then
            pip install -r requirements-lock.txt
          else
            pip install -r requirements.txt
          fi
      - name: Run kernel unit tests
        run: |
          pytest kernel/tests/ -v --cov=kernel --cov-report=term-missing --cov-report=html --cov-report=xml
      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-coverage-html
          path: htmlcov/
          retention-days: 7
      - name: Upload coverage XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-coverage-xml
          path: coverage.xml
          retention-days: 7

  # ===========================================================================
  # Job 4: G2 Sanity Checks (Project Tests)
  # ===========================================================================
  gate-g2-sanity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check DGSF submodule availability
        run: |
          if [ -d "projects/dgsf/repo" ]; then
            echo "DGSF_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "DGSF_AVAILABLE=false" >> $GITHUB_ENV
          fi
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          pip install PyYAML pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ "${DGSF_AVAILABLE}" = "true" ] && [ -f projects/dgsf/repo/requirements.txt ]; then
            pip install -r projects/dgsf/repo/requirements.txt
          fi
      - name: Run G2 gate checks
        run: python scripts/gate_check.py --gate G2 --output markdown
        continue-on-error: true
      - name: Verify state consistency
        run: |
          if [ -f scripts/verify_state.py ]; then
            python scripts/verify_state.py
          else
            echo "⚠️ verify_state.py not found, skipping state verification"
          fi
        continue-on-error: true
      - name: Upload gate report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gate-g2-report
          path: reports/gates/
          retention-days: 30

  # ===========================================================================
  # Job 4: Schema Validation (G1 Partial)
  # ===========================================================================
  gate-g1-schema:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[data]') || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: pip install PyYAML jsonschema
      - name: Validate schemas
        run: |
          python -c "
          import json
          import yaml
          from pathlib import Path
          
          errors = []
          configs = Path('projects/dgsf/repo/configs')
          
          if configs.exists():
              for f in configs.glob('*.yaml'):
                  try:
                      with open(f) as h:
                          yaml.safe_load(h)
                      print(f'✅ {f.name}')
                  except Exception as e:
                      print(f'❌ {f.name}: {e}')
                      errors.append(f)
              
              for f in configs.glob('*.json'):
                  try:
                      with open(f) as h:
                          json.load(h)
                      print(f'✅ {f.name}')
                  except Exception as e:
                      print(f'❌ {f.name}: {e}')
                      errors.append(f)
          
          if errors:
              exit(1)
          "

  # ===========================================================================
  # Job 5: Type Checking
  # ===========================================================================
  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: pip install PyYAML mypy
      - name: Run mypy on kernel
        run: mypy kernel/ --ignore-missing-imports --no-error-summary || true
        continue-on-error: true

  # ===========================================================================
  # Job 6: Gate G3 (Code Review)
  # ===========================================================================
  gate-g3:
    runs-on: ubuntu-latest
    needs: [gate-g2-sanity]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-lock.txt
      - name: Run Gate G3 (Code Review)
        run: python scripts/run_gate_g3.py --output text
        continue-on-error: true  # G3为建议性门禁

  # ===========================================================================
  # Job 7: Gate G4 (Architecture Check)
  # ===========================================================================
  gate-g4:
    runs-on: ubuntu-latest
    needs: [gate-g3]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-lock.txt
      - name: Run Gate G4 (Architecture Check)
        run: python scripts/run_gate_g4.py --output text
        continue-on-error: true  # G4为建议性门禁

  # ===========================================================================
  # Job 8: Gate G5 (Merge Ready)
  # ===========================================================================
  gate-g5:
    runs-on: ubuntu-latest
    needs: [gate-g4]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-lock.txt
      - name: Run Gate G5 (Merge Ready)
        run: python scripts/run_gate_g5.py --output text
        # G5为阻塞性门禁，失败则阻止合并

  # ===========================================================================
  # Job 9: Gate G6 (Post-Merge Validation)
  # ===========================================================================
  gate-g6:
    runs-on: ubuntu-latest
    needs: [gate-g5]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-lock.txt
      - name: Run Gate G6 (Post-Merge)
        run: python scripts/run_gate_g6.py --output text
        continue-on-error: true  # G6为通知性门禁

  # ===========================================================================
  # Summary Job
  # ===========================================================================
  ci-summary:
    runs-on: ubuntu-latest
    needs: [policy-check, governance-check, gate-g2-sanity, gate-g3, gate-g4, gate-g5]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Policy Check | ${{ needs.policy-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Governance Check | ${{ needs.governance-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| G2 Sanity | ${{ needs.gate-g2-sanity.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| G3 Code Review | ${{ needs.gate-g3.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| G4 Architecture | ${{ needs.gate-g4.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| G5 Merge Ready | ${{ needs.gate-g5.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.policy-check.result }}" == "failure" ]] || \
             [[ "${{ needs.governance-check.result }}" == "failure" ]] || \
             [[ "${{ needs.gate-g5.result }}" == "failure" ]]; then
            echo ""
            echo "❌ CI failed - check individual jobs for details"
            exit 1
          fi
          echo ""
          echo "✅ All critical checks passed"
